<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Orders</title>
</head>

<style>
  #all-orders-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding: 20px 20px 20px 20px;
    max-width: 100%;
  }

  #all-orders-table {
    border-collapse: collapse;
    font-size: 0.9em;
    max-width: 100%;
    width: 100%;
    margin-bottom: 50px;
  }

  #all-orders-table tr th {
    border: 1px solid black;
    border-collapse: collapse;
  }

  .order-id-td, .order-total-td, .order-status-td, .order-number {
    vertical-align: top;
    text-align: center;
    padding: 10px 0 0 0;
  }

  .order-customer-info div{
    display: flex;
    justify-content: center;
    align-items: flex-start;
    flex-direction: column;
    font-size: 0.9em;
    margin-right: 5px;
  }

  .order-status-td div {
    width: 90%;
    display: inline-block;
    font-size: 0.9em;
  }

  .order-content {
    padding: 0;
  }

  .each-order-table{
    border: 1px solid black;
    border-collapse: collapse;
    font-size: 0.8em;
  }

  td {
    text-align: center;
    vertical-align: middle;
    padding: 10px 0 10px 0;
    border: 1px solid black;
    border-collapse: collapse;
  }

  .each-order-table td a {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0;
  }

  td img {
    width: 100%;
    height: 100%;
  }

</style>

<body>

  {% extends "admin_profile.html" %}

  {% block lower_container %}
  <div id="all-orders-container">
    <h2>جميع الطلبات</h2>
    <table id="all-orders-table">
      <tr>
        <th style="width: 3%">#</th>
        <th style="width: 8%;">رقم الطلب</th>
        <th style="width: 20%;">معلومات الزبون</th>
        <th>محتوى الطلب</th>
        <th style="width: 10%;">السعر الكلي</th>
        <th style="width: 15%;">حالة الطلب</th>
      </tr>
      <script>
        let orderTotal = 0;
        let initialValue = "";
      </script>
      {% for order in all_orders %}
      <script>
        orderTotal = 0;
      </script>
      <tr>
        <td class="order-number">#{{loop.index}}</td>
        <td class="order-id-td">{{order[0]}}</td>
        <td class="order-customer-info" style="vertical-align: top;">
          <div>
            <span id="order-customer-fullname">
              إسم الزبون:
              {{order[3]}} {{order[4]}}
            </span>
  <!--          <span id="order-customer-role">-->
  <!--            {{order[5]}}-->
  <!--          </span>-->
            <span id="order-customer-city">
              البلد:
              {{order[6]}}
            </span>
            <span id="order-customer-address">
              العنوان:
              {{order[7]}}
            </span>
            <span id="order-customer-email">
              إيميل:
              {{order[8]}}
            </span>
            <span id="order-customer-phone-number">
              رقم الهاتف الشخصي:
              {{order[10]}}
            </span>
            <span id="order-customer-backup-phone">
              هاتف إحتياطي:
              {% if order[9] == "" %}
                  -
              {% else %}
                {{order[9]}}
              {% endif %}
            </span>
            <span id="order-customer-order-date">
              تاريخ الطلب:
              {{order[11]}}
            </span>
          </div>
        </td>
        <td class="order-content">
          <table class="each-order-table">
            <tr>
              <th style="width: 10%">رقم المنتج</th>
              <th style="width: 20%">صورة المنتج</th>
              <th>إسم المنتج</th>
              <th style="width: 15%">السعر</th>
              <th style="width: 10%">الكمية</th>
            </tr>
            {% for id_num, (quantity, item) in order[-2].items() %}
            <tr>
              <td style="vertical-align: top; text-decoration: Highlight">
                {{item[0]}}
              </td>
              <td>
                <a href="{{url_for('product', name=item[1], ptype=item[2], id_num=item[0])}}">
                  <img src="../{{item[3]}}" alt="item">
                </a>
              </td>
              <td style="vertical-align: top">
                {{item[1]}}
              </td>
              <td style="vertical-align: top">
                {{item[4]}} ₪
              </td>
              <td style="vertical-align: top">
                {{quantity}}
              </td>
            </tr>
            <script>
              orderTotal += parseInt("{{quantity}}") * parseFloat("{{item[4]}}");
            </script>
            {% endfor %}
          </table>
        </td>
        <td class="order-total-td" style="font-size: 0.8em; padding-bottom: 20px">
          <span id="subtotal">
            مجموع جزئي:
            <b>{{order[-4]}}</b> ₪
            <br>
            <script>
                totalNoShip = parseFloat("{{order[-4]}}") - parseFloat("{{order[-1]}}");
                document.currentScript.parentNode.children[0].textContent = totalNoShip.toString();
            </script>
          </span>
          <span id="shipping-fee" style="border-bottom: 1px solid black;">
            رسوم شحن:
            <b>{{order[-1]}}</b> ₪
          </span>
          <br><br>
          <b>
            مجموع الطلب: {{order[-4]}} ₪
          </b>
        </td>
        <td class="order-status-td">
          <div id="status-container{{loop.index}}">
            <select disabled>
              <option value="تم تأكيد الطلب">
                تم تأكيد الطلب
              </option>
              <option value="تم تجهيز الطلب">
                تم تجهيز الطلب
              </option>
              <option value="الطلب في الطريق">
                الطلب في الطريق
              </option>
              <option value="تم التوصيل">
                تم التوصيل
              </option>
              <script>
                  selectNode = document.currentScript.parentNode;
                  for (let i = 0; i < selectNode.children.length; i++) {
                      if (selectNode.children[i].value === "{{order[-3]}}") {
                          selectNode.selectedIndex = i;
                      }
                  }
              </script>
            </select>
            <button onclick="UpdateStatus(this)" style="cursor: pointer; margin-top: 10px">
              تعديل الحالة
            </button>
<!--            <span class="material-symbols-outlined order-shipped" style="display: none">-->
<!--              local_shipping-->
<!--            </span>-->
<!--            <span class="material-symbols-outlined order-approved" style="display: none">-->
<!--              order_approve-->
<!--            </span>-->
<!--            <span class="material-symbols-outlined order-done" style="display: none">-->
<!--              check_circle-->
<!--            </span>-->
            <form method="post" style="display: none" id="status-form">
              <input id="order-status-update" type="hidden" name="order-status-update">
            </form>
          </div>
        </td>
        <script>
            initialValue = document.getElementById("status-container{{loop.index}}").children[0].value;
            function UpdateStatus(button) {
                const selectNode = button.parentNode.children[0];
                if (selectNode.hasAttribute("disabled")) {
                    selectNode.removeAttribute("disabled");
                } else {
                    selectNode.setAttribute("disabled", "true");
                    if (selectNode.value !== initialValue) {
                        document.getElementById("order-status-update").value = button.parentNode.parentNode.parentNode.children[1].textContent + "," + selectNode.value;
                        document.getElementById("status-form").submit();
                    }
                }
            }
        </script>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endblock %}

</body>
</html>